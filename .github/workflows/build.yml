name: Build App

env:
  # === App Identity (edit these to produce your own branded builds) ===
  APP_SLUG: sunflower
  APP_PRODUCT_NAME: Sunflower Browser
  # Reverse-DNS style identifier (important for Flatpak / app identity)
  APP_ID: dev.sun.sunflower
  # npm package name used by electron-builder templates like ${name}
  APP_PACKAGE_NAME: sunflower-browser
  # Desktop file used for xdg-settings default browser
  DESKTOP_FILE: sunflower.desktop

permissions:
  pull-requests: write

on:
  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

  # Run on every push to a pull request
  pull_request:
    types: [opened, synchronize, reopened]

# Cancel in-progress jobs when a new push is made to the same PR
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  # Runs the build
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Check out Git repository
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4.3.0

      - name: Comment PR with build status
        if: github.event_name == 'pull_request'
        continue-on-error: true
        uses: thollander/actions-comment-pull-request@24bffb9b452ba05a4f3f77933840a6a841d1b32b # v3.0.1
        with:
          message: |
            ### Build is in progress... ðŸš€
            Currently building for this pull request!
          comment-tag: build

      - name: Install Node.js, NPM and Yarn
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4.4.0
        with:
          node-version: 22

      - name: Setup Bun
        uses: oven-sh/setup-bun@735343b667d3e6f658f44d0eca948eb6282f2b76 # v2.0.2
        with:
          bun-version: latest

      - name: Install Dependencies
        run: bun install --development --frozen-lockfile
        env:
          SHARP_IGNORE_GLOBAL_LIBVIPS: 1

      - name: Patch app identity (rename)
        run: bun run scripts/ci/patch-app-identity.mjs

      - name: Build Linux (AppImage only)
        run: |
          bun run build
          bunx electron-builder --linux AppImage -p never

      - name: Inspect dist output
        run: |
          echo "PWD=$(pwd)"
          ls -la
          echo "---- dist/ ----"
          ls -la dist || true
          echo "---- dist files ----"
          find dist -maxdepth 2 -type f -print || true

      - name: Upload Build Artifacts
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: linux-appimage
          if-no-files-found: error
          path: |
            dist/*.AppImage
            dist/*.yml

      - name: Comment PR with artifact link
        if: github.event_name == 'pull_request'
        uses: thollander/actions-comment-pull-request@24bffb9b452ba05a4f3f77933840a6a841d1b32b # v3.0.1
        continue-on-error: true
        with:
          message: |
            ### Linux AppImage build is ready! ðŸš€
            Download the artifact:
            - [Linux (AppImage)](https://nightly.link/${{ github.repository }}/actions/runs/${{ github.run_id }}/linux-appimage.zip)

            _(execution **${{ github.run_id }}** / attempt **${{ github.run_attempt }}**)_
          comment-tag: build
